# NIPT问题1分析报告：胎儿Y染色体浓度与孕周、BMI关系建模

## 首先我们先解决第一小问

因为后续两个部分（BMI分组和NIPT时点优化）都是要基于这个部分来继续拓展，所以这部分特别重要，也是是否能获奖的关键，大家一定要好好做这部分，下面提供我的思路给大家：

在NIPT（无创产前检测）技术中，我们需要分析胎儿Y染色体浓度与孕妇孕周数和BMI等指标的相关特性，建立相应的关系模型，并检验其显著性。我们需要回答以下几个问题：

**Y染色体浓度与孕周的关系**：我们需要分析孕周对Y染色体浓度的影响，是否存在非线性关系。
**Y染色体浓度与BMI的关系**：我们需要分析BMI对Y染色体浓度的影响，是否存在最优BMI区间。
**多变量关系建模**：我们需要建立Y染色体浓度与孕周、BMI的联合关系模型。
**模型诊断与验证**：我们需要检验模型的统计显著性和预测能力。

这个问题的核心是建立Y染色体浓度与孕周、BMI之间的数学关系模型。由于Y染色体浓度具有正值约束、可能的异方差性以及非线性关系特征，传统的线性回归模型无法很好地捕捉这些特性。因此，我们需要采用更高级的统计建模方法来解决这个问题，所以我打算使用Gamma-GLM和样条回归去解这一问。

## 数据预处理与标准化

首先，我们需要将Y染色体浓度数据进行预处理。假设每个样本的数据由孕周、BMI、Y染色体浓度构成，形式为：

$$Y_i = [J_i, K_i, V_i]$$

其中 $$Y_i$$ 代表第 $$i$$ 个样本的孕周、BMI、Y染色体浓度。为了使得数据适合统计建模，我们需要对数据进行标准化处理，以避免变量之间的量级差异。

对于BMI，我们采用Z-score标准化：

$$K_{std} = \frac{K - \bar{K}}{S_K}$$

其中 $$\bar{K}$$ 为BMI的均值，$$S_K$$ 为BMI的标准差。

对于孕周，我们采用中心化处理：

$$J_{centered} = J - \bar{J}$$

其中 $$\bar{J}$$ 为孕周的均值。

## 相关性分析

### Pearson相关系数

对于变量 $X$ 和 $Y$，Pearson相关系数定义为：

$$\rho_{XY} = \frac{\text{Cov}(X,Y)}{\sqrt{\text{Var}(X)\text{Var}(Y)}} = \frac{\sum_{i=1}^{n}(x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^{n}(x_i - \bar{x})^2\sum_{i=1}^{n}(y_i - \bar{y})^2}}$$

其中 $$\bar{x} = \frac{1}{n}\sum_{i=1}^{n}x_i$$，$$\bar{y} = \frac{1}{n}\sum_{i=1}^{n}y_i$$。

### Spearman相关系数

Spearman相关系数基于秩次，对异常值更稳健：

$$\rho_s = 1 - \frac{6\sum_{i=1}^{n}d_i^2}{n(n^2-1)}$$

其中 $$d_i$$ 为 $$X$$ 和 $$Y$$ 的秩次差。

### 偏相关分析

控制测序质量变量 $$Z$$ 后，$$X$$ 和 $$Y$$ 的偏相关系数为：

$$\rho_{XY|Z} = \frac{\rho_{XY} - \rho_{XZ}\rho_{YZ}}{\sqrt{(1-\rho_{XZ}^2)(1-\rho_{YZ}^2)}}$$

在代码中，我们通过以下步骤计算偏相关：

1. 构建控制变量矩阵：$$Z = [GC, map\_rate, filt\_rate, reads]$$
2. 计算各变量的残差：
   - $$r_V = V - \hat{V}_{Z}$$（Y染色体浓度残差）
   - $$r_J = J - \hat{J}_{Z}$$（孕周残差）
   - $$r_K = K - \hat{K}_{Z}$$（BMI残差）
3. 计算残差间的相关系数

## 非线性建模：样条回归

### 三次截断幂样条

为捕捉孕周 $$J$$ 的非线性效应，采用三次截断幂样条：

$$f(J) = \beta_0 + \beta_1 J + \beta_2 J^2 + \beta_3 J^3 + \sum_{k=1}^{K} \gamma_k (J - \xi_k)_+^3$$

其中：
- $$(J - \xi_k)_+^3 = \max(0, J - \xi_k)^3$$ 为截断幂函数
- $$\xi_k$$ 为样条结点，$$k = 1, 2, \ldots, K$$
- $$K$$ 为内部结点数量（代码中设为4）

### 结点选择策略

采用分位数方法选择结点：

$$\xi_k = Q_{J}\left(\frac{k}{K+1}\right), \quad k = 1, 2, \ldots, K$$

其中 $$Q_{J}(p)$$ 为孕周的第 $$p$$ 分位数。

在代码中，我们使用：
```python
quantiles = np.linspace(0.2, 0.8, n_knots)  # [0.2, 0.4, 0.6, 0.8]
knots = np.quantile(xc, quantiles)
```

## Gamma广义线性模型

### 模型结构

由于Y染色体浓度 $$V > 0$$，采用Gamma分布建模：

$$V \sim \text{Gamma}(\mu, \phi)$$

其中 $$\mu$$ 为均值参数，$$\phi$$ 为形状参数。

### 对数链接函数

$$\log(\mu) = \eta = \mathbf{X}\boldsymbol{\beta}$$

其中 $$\mathbf{X}$$ 为设计矩阵，$$\boldsymbol{\beta}$$ 为回归系数。

### 设计矩阵构建

$$\mathbf{X} = [\mathbf{1}, \mathbf{J}, \mathbf{J}^2, \mathbf{J}^3, \mathbf{B}_1, \mathbf{B}_2, \mathbf{B}_3, \mathbf{B}_4, \mathbf{K}, \mathbf{K}^2]$$

其中：
- $$\mathbf{J}$$ 为中心化后的孕周
- $$\mathbf{B}_k = (\mathbf{J} - \xi_k)_+^3$$ 为样条基函数
- $$\mathbf{K}$$ 为标准化后的BMI

### 参数估计

采用最大似然估计：

$$\hat{\boldsymbol{\beta}} = \arg\max_{\boldsymbol{\beta}} \sum_{i=1}^{n} \log f(v_i | \mu_i, \phi)$$

在代码中，我们使用statsmodels的GLM模块：
```python
glm_gamma = sm.GLM(y_pos, X_full, family=sm.families.Gamma(sm.families.links.log()))
res_glm = glm_gamma.fit(maxiter=200)
```

## 分位数回归

### 分位数回归模型

对于第 $$\tau$$ 分位数：

$$Q_\tau(V | \mathbf{X}) = \mathbf{X}\boldsymbol{\beta}_\tau$$

其中 $$Q_\tau(V | \mathbf{X})$$ 为条件分位数函数。

### 参数估计

通过最小化加权绝对偏差：

$$\hat{\boldsymbol{\beta}}_\tau = \arg\min_{\boldsymbol{\beta}} \sum_{i=1}^{n} \rho_\tau(v_i - \mathbf{x}_i^T\boldsymbol{\beta})$$

其中 $$\rho_\tau(u) = u(\tau - I(u < 0))$$ 为损失函数。

在代码中，我们分析三个分位数：
```python
taus = [0.25, 0.5, 0.75]  # 25%、50%、75%分位数
```

## 模型诊断与验证

### 残差分析

#### 偏差残差

Gamma-GLM的偏差残差定义为：

$$r_i^D = \text{sign}(v_i - \hat{\mu}_i)\sqrt{2[\log f(v_i | \hat{\mu}_i, \hat{\phi}) - \log f(v_i | v_i, \hat{\phi})]}$$

#### 标准化残差

$$r_i^S = \frac{r_i^D}{\sqrt{1 - h_{ii}}}$$

其中 $$h_{ii}$$ 为帽子矩阵的对角元素。

#### QQ图诊断

通过QQ图检验残差的正态性，我们使用模拟分位带：

1. 生成300次模拟的正态分布数据
2. 计算2.5%和97.5%分位数
3. 绘制置信带和样本点

在代码中：
```python
theo = np.sort(np.random.normal(size=(sims, n)), axis=1)
lo = np.percentile(theo, 2.5, axis=0)
hi = np.percentile(theo, 97.5, axis=0)
```

### 影响点诊断

#### Cook距离

$$D_i = \frac{r_i^2 h_{ii}}{p(1 - h_{ii})^2}$$

其中 $$p$$ 为参数个数。

阈值标准：
$$D_i > \frac{4}{n}$$

#### 杠杆值

$$h_{ii} = \mathbf{x}_i^T(\mathbf{X}^T\mathbf{X})^{-1}\mathbf{x}_i$$

### 异方差检验

#### Breusch-Pagan检验

检验统计量：

$$\text{LM} = \frac{1}{2}\mathbf{e}^T\mathbf{Z}(\mathbf{Z}^T\mathbf{Z})^{-1}\mathbf{Z}^T\mathbf{e}$$

其中 $$\mathbf{e}$$ 为残差向量，$$\mathbf{Z}$$ 为辅助回归变量矩阵。

在代码中：
```python
bp_lm, bp_lm_p, bp_f, bp_f_p = het_breuschpagan(ols_ref.resid, ols_ref.model.exog)
```

## 预测模型

### 点预测

$$\hat{V} = \exp(\hat{\eta}) = \exp(\mathbf{x}^T\hat{\boldsymbol{\beta}})$$

### 预测函数实现

在代码中，我们实现了预测函数：

```python
def predict_curve_glm(weeks, bmi_value, res, gw_center, gw_knots):
    # 构建孕周的样条基
    xc = weeks - gw_center
    Xg = np.column_stack([xc, xc**2, xc**3])
    for k in gw_knots:
        Xg = np.column_stack([Xg, np.maximum(0.0, xc - k)**3])
    
    # 构建BMI项
    bmi_c0 = (bmi_value - df["bmi"].values.mean())/df["bmi"].values.std()
    bmi2_c0 = bmi_c0**2
    
    # 组合设计矩阵
    X_new = np.column_stack([const, Xg, bmi_block])
    mu = res.predict(X_new)
    return mu
```

## 结果分析

### 相关性分析结果

通过Pearson和Spearman相关系数分析，我们发现：

- **孕周与Y浓度**: 呈显著正相关
- **BMI与Y浓度**: 呈负相关
- **偏相关分析**: 控制测序质量变量后，生物学关系更清晰

### 非线性关系建模

通过三次截断幂样条，孕周效应可表示为：

$$\hat{f}(J) = \hat{\beta}_0 + \hat{\beta}_1 J + \hat{\beta}_2 J^2 + \hat{\beta}_3 J^3 + \sum_{k=1}^{4} \hat{\gamma}_k (J - \xi_k)_+^3$$

BMI的效应包含线性和二次项：

$$\hat{g}(K) = \hat{\alpha}_1 K + \hat{\alpha}_2 K^2$$

### 模型拟合优度

#### 伪决定系数

$$R^2 = 1 - \frac{D_{\text{res}}}{D_{\text{null}}}$$

其中 $$D_{\text{res}}$$ 为残差偏差，$$D_{\text{null}}$$ 为零模型偏差。

#### 模型诊断

通过残差分析、影响点检测和异方差检验，验证了模型假设的合理性。

## 生物学意义解释

### 孕周效应

孕周对Y染色体浓度的影响反映了胎儿发育的生物学过程：

- **早期妊娠** (8-12周): 胎儿DNA释放量少，浓度较低
- **中期妊娠** (13-20周): 胎盘发育完善，DNA释放增加
- **晚期妊娠** (21-30周): 浓度趋于稳定，检测效果最佳

### BMI效应

#### 稀释效应

高BMI孕妇血液体积增加，导致胎儿DNA被稀释：

$$V_{\text{observed}} = \frac{V_{\text{actual}} \cdot V_{\text{blood,normal}}}{V_{\text{blood,actual}}}$$

#### 最优BMI区间

通过二次函数分析，存在最优BMI区间：

$$\frac{\partial V}{\partial K} = \alpha_1 + 2\alpha_2 K = 0 \Rightarrow K_{\text{opt}} = -\frac{\alpha_1}{2\alpha_2}$$

## 结论

### 主要发现

1. **显著相关性**: 孕周与Y染色体浓度呈显著正相关，BMI与Y染色体浓度呈负相关
2. **非线性特征**: 孕周效应呈现明显的非线性特征，存在增长平台期
3. **模型有效性**: Gamma-GLM模型具有良好的拟合效果和预测能力
4. **临床指导**: 为NIPT检测时点选择提供了科学依据

### 模型优势

1. **生物学合理性**: 考虑了Y染色体浓度的正值约束
2. **非线性建模**: 样条函数捕捉了复杂的非线性关系
3. **稳健性**: 分位数回归提供了稳健的估计
4. **诊断完善**: 全面的模型诊断和验证

### 应用价值

1. **个体化检测**: 根据孕妇BMI制定个性化检测方案
2. **时点优化**: 确定不同BMI组的最优检测时点
3. **质量控制**: 建立检测质量评估标准
4. **风险预测**: 预测检测失败的概率

---

*报告完成时间: 2025年*  
*分析工具: Python + statsmodels + scipy*  
*统计方法: Gamma-GLM, 样条回归, 分位数回归*